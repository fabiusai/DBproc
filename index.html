<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Contratti | Dashboard</title>
    <link rel="icon" href="favicon.ico">
    <style>
        /* --- CSS BASE E VARIABILI --- */
        :root {
            --brand-blue: #0146bc; --brand-yellow: #eddc01; --bg-color: #f5f5f7;
            --surface-color: #ffffff; --text-main: #1d1d1f; --text-muted: #86868b;
            --border-color: #d2d2d7; --radius-box: 12px; --radius-btn: 8px; --spacing: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-main); line-height: 1.5; -webkit-font-smoothing: antialiased; }

        /* --- HEADER E NAVIGAZIONE --- */
        header { background-color: var(--brand-blue); color: #ffffff; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--brand-yellow); }
        header h2 { font-weight: 600; font-size: 1.25rem; }
        nav { display: flex; gap: 0.5rem; }
        nav button { background-color: transparent; color: #ffffff; border: 1px solid transparent; padding: 0.5rem 1rem; border-radius: var(--radius-btn); font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        nav button:hover, nav button.active-nav { background-color: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.3); }

        main { padding: var(--spacing); max-width: 1200px; margin: 0 auto; }

        /* --- BOX, BOTTONI E FORM --- */
        .box { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--radius-box); padding: var(--spacing); margin-bottom: var(--spacing); }
        .box-header { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: flex-end; }
        .box-header h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem; }
        .box-header p { color: var(--text-muted); font-size: 0.9rem; }

        .btn { background-color: var(--brand-blue); color: #ffffff; border: none; padding: 0.75rem 1.5rem; border-radius: var(--radius-btn); font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn:hover { background-color: #013a9b; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background-color: var(--border-color); color: var(--text-muted); cursor: not-allowed; }
        .btn-yellow { background-color: var(--brand-yellow); color: var(--text-main); }
        .btn-yellow:hover { background-color: #d6c600; }
        .btn-outline { background-color: transparent; color: var(--brand-blue); border: 1px solid var(--brand-blue); }
        .btn-outline:hover { background-color: rgba(1, 70, 188, 0.05); }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        
        .btn-icon { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 0.9rem; padding: 0.2rem 0.4rem; margin-right: 0.3rem; transition: all 0.2s; }
        .btn-icon:hover { background: var(--surface-color); border-color: var(--brand-blue); }
        .btn-icon-danger:hover { border-color: #d93025; background: #ffebeb; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.4rem; color: var(--text-main); }
        input[type="text"], input[type="number"], input[type="date"], textarea, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; font-family: inherit; background-color: var(--bg-color); transition: border-color 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--brand-blue); background-color: var(--surface-color); }
        
        .search-bar { width: 100%; max-width: 400px; padding: 0.75rem 1rem 0.75rem 2.5rem; border-radius: 20px; border: 1px solid var(--border-color); background-color: var(--bg-color); font-size: 0.95rem; }

        /* --- COMPONENTI UI --- */
        .contract-card { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--radius-box); padding: 1.25rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; transition: box-shadow 0.2s; }
        .contract-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .card-info h4 { margin-bottom: 0.25rem; font-size: 1.1rem; color: var(--brand-blue); }
        .card-info p { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.2rem; }
        .badge-tipo { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
        .badge-quadro { background-color: rgba(1, 70, 188, 0.1); color: var(--brand-blue); }
        .badge-diretta { background-color: rgba(237, 220, 1, 0.3); color: #8a7b00; }
        .badge-terzi { background-color: #f0f0f5; color: var(--text-muted); }
        .card-actions { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;}
        .card-actions .valore { font-size: 1.25rem; font-weight: 600; display: block; }

        .segmented-control { display: flex; background-color: var(--bg-color); border-radius: 8px; padding: 4px; margin-bottom: 2rem; border: 1px solid var(--border-color); }
        .segmented-control button { flex: 1; padding: 0.5rem 1rem; border: none; background: transparent; font-weight: 600; color: var(--text-muted); border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .segmented-control button.active-segment { background-color: var(--surface-color); color: var(--brand-blue); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .budget-row { display: flex; gap: 1rem; margin-bottom: 0.75rem; align-items: center; background: var(--bg-color); padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border-color); }
        .status-badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600; }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }

        /* --- VISTE E MODALI --- */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        .contract-form { display: none; }
        .contract-form.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .dettaglio-header { background: var(--brand-blue); color: white; padding: 1.5rem; border-radius: var(--radius-box); margin-bottom: 1.5rem; }
        .dettaglio-header h3 { margin-bottom: 0.5rem; }
        .dettaglio-note { background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 6px; margin-top: 1rem; font-size: 0.9rem; font-style: italic; }

        .ordine-card { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; overflow: hidden; }
        .ordine-header { background: var(--bg-color); padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .ordine-body { padding: 1rem; }
        .vap-row { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px dashed var(--border-color); font-size: 0.9rem; }
        .vap-row:last-child { border-bottom: none; }
        .vap-assestamento { font-size: 0.75rem; background: var(--brand-yellow); color: #000; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background: var(--surface-color); padding: 2rem; border-radius: var(--radius-box); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h3 { font-size: 1.25rem; }
        .btn-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.9rem;}
        .checkbox-group input { width: auto; }
    </style>
</head>
<body>

    <header>
        <h2>Gestione Contratti</h2>
        <nav>
            <button class="active-nav" onclick="switchView('dashboard', this)">Dashboard</button>
            <button onclick="switchView('contratti', this); pulisciFormContratto();">Nuovo Contratto</button>
            <button onclick="switchView('impostazioni', this)">Impostazioni</button>
        </nav>
    </header>

    <main>
        <section id="dashboard" class="view-section active">
            <div class="segmented-control" style="margin-bottom: 1.5rem;">
                <button class="active-segment" id="tab-archivio" onclick="switchDashboardTab('archivio')">Archivio Completo</button>
                <button id="tab-attivi" onclick="switchDashboardTab('attivi')">Contratti Attivi</button>
                <button id="tab-budget" onclick="switchDashboardTab('budget')">Budget Annuale</button>
            </div>

            <div id="dash-archivio" class="dash-tab-content">
                <div class="box">
                    <div class="box-header">
                        <div><h3>Archivio Contratti</h3><p>Visualizza e gestisci tutti i contratti in database.</p></div>
                        <input type="text" id="search-contratti" class="search-bar" placeholder="üîç Cerca fornitore o numero..." oninput="renderDashboard()">
                    </div>
                    <div id="lista-contratti-container"></div>
                </div>
            </div>

            <div id="dash-attivi" class="dash-tab-content" style="display:none;">
                <div class="box">
                    <div class="box-header">
                        <div><h3>Contratti Attivi</h3><p>Elenco basato sulla data di scadenza odierna.</p></div>
                    </div>
                    <div id="lista-contratti-attivi"></div>
                </div>
            </div>

            <div id="dash-budget" class="dash-tab-content" style="display:none;">
                <div class="box">
                    <div class="box-header">
                        <div><h3>Analisi Budget Annuale</h3><p>Dettaglio spese della mia struttura per anno di esercizio.</p></div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <label>Anno:</label>
                            <input type="number" id="budget-anno-filter" value="2026" style="width:80px;" onchange="renderBudgetAnnuale()">
                        </div>
                    </div>
                    <div id="report-budget-container"></div>
                </div>
            </div>
        </section>

        <section id="gestione-spese" class="view-section">
            <button class="btn btn-outline" style="margin-bottom: 1rem;" onclick="switchView('dashboard', document.querySelector('nav button:first-child'))">‚Üê Torna alla Dashboard</button>
            <div class="dettaglio-header" id="spese-header"></div>
            <div id="spese-content" class="box"></div>
        </section>

        <section id="contratti" class="view-section">
            <div class="box">
                <div class="box-header">
                    <h3 id="titolo-form-contratto">Inserimento Nuovo Contratto</h3>
                    <p>Compila i campi per salvare o aggiornare il contratto nel database.</p>
                </div>

                <div class="segmented-control" id="contract-selector">
                    <button class="active-segment" id="seg-quadro" onclick="switchContractType('form-quadro', this)">Contratto Quadro</button>
                    <button id="seg-diretta" onclick="switchContractType('form-diretta', this)">Assegnazione Diretta</button>
                    <button id="seg-terzi" onclick="switchContractType('form-terzi', this)">Terze Funzioni</button>
                </div>
                
                <div id="form-quadro" class="contract-form active">
                    <div class="form-grid">
                        <div class="input-group"><label>Fornitore</label><input type="text" id="cq-fornitore"></div>
                        <div class="input-group"><label>Numero Identificativo</label><input type="text" id="cq-numero"></div>
                        <div class="input-group"><label>Data Inizio</label><input type="date" id="cq-inizio"></div>
                        <div class="input-group"><label>Data Fine</label><input type="date" id="cq-fine"></div>
                        <div class="input-group"><label>Valore (Netto ‚Ç¨)</label><input type="text" inputmode="decimal" id="cq-valore" placeholder="Es. 31.000,02" oninput="calcolaQuadratura()"></div>
                        <div class="input-group" style="grid-column: 1 / -1;"><label>Note</label><textarea id="cq-note" rows="2"></textarea></div>
                    </div>
                    <div style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4>Ripartizione Budget</h4>
                            <span id="cq-status-quadratura" class="status-badge" style="background: #ffebeb; color: #d93025;">Da quadrare</span>
                        </div>
                        <div id="container-ripartizioni"></div>
                        <button class="btn btn-outline" style="margin-top: 1rem;" onclick="aggiungiRigaBudget()">+ Aggiungi Quota</button>
                    </div>
                </div>

                <div id="form-diretta" class="contract-form">
                    <div class="form-grid">
                        <div class="input-group"><label>Fornitore</label><input type="text" id="cd-fornitore"></div>
                        <div class="input-group"><label>Numero Identificativo</label><input type="text" id="cd-numero"></div>
                        <div class="input-group"><label>Data Inizio</label><input type="date" id="cd-inizio"></div>
                        <div class="input-group"><label>Data Fine</label><input type="date" id="cd-fine"></div>
                        <div class="input-group"><label>Valore (Netto ‚Ç¨)</label><input type="text" inputmode="decimal" id="cd-valore" placeholder="Es. 31.000,02"></div>
                        <div class="input-group" style="grid-column: 1 / -1;"><label>Note</label><textarea id="cd-note" rows="2"></textarea></div>
                    </div>
                </div>

                <div id="form-terzi" class="contract-form">
                    <div class="form-grid">
                        <div class="input-group"><label>Fornitore</label><input type="text" id="ct-fornitore"></div>
                        <div class="input-group"><label>Funzione Gestore</label><input type="text" id="ct-funzione"></div>
                        <div class="input-group"><label>Data Inizio</label><input type="date" id="ct-inizio"></div>
                        <div class="input-group"><label>Data Fine</label><input type="date" id="ct-fine"></div>
                        <div class="input-group"><label>Valore Imputato (Netto ‚Ç¨)</label><input type="text" inputmode="decimal" id="ct-valore" placeholder="Es. 31.000,02"></div>
                        <div class="input-group" style="grid-column: 1 / -1;"><label>Note</label><textarea id="ct-note" rows="2"></textarea></div>
                    </div>
                </div>

                <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                    <button class="btn btn-outline" onclick="pulisciFormContratto()">Annulla</button>
                    <button class="btn btn-yellow" id="btn-salva-contratto" onclick="salvaContrattoAttivo(this)">Salva Contratto</button>
                </div>
            </div>
        </section>

        <section id="impostazioni" class="view-section box">
            <div style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);">
                <h3>Configurazione Funzioni Aziendali</h3>
                <div class="form-grid" style="margin-top: 1rem;">
                    <div class="input-group">
                        <label>La Mia Funzione (Primaria)</label>
                        <input type="text" id="cfg-mia-funzione" placeholder="Es. ICT" onchange="salvaConfigurazione()">
                    </div>
                    <div class="input-group">
                        <label>Altre Funzioni (Separate da virgola)</label>
                        <input type="text" id="cfg-altre-funzioni" placeholder="Es. HR, Marketing, Sales" onchange="salvaConfigurazione()">
                    </div>
                </div>
            </div>
            <h3>Gestione Dati Locali</h3>
            <p style="margin-bottom: 1.5rem; color: var(--text-muted);">Esporta il database per il backup, importa un backup esistente o formatta il sistema.</p>
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <button class="btn btn-outline" onclick="exportData(this)">üíæ Esporta JSON</button>
                <label class="btn btn-outline" for="import-file" style="margin: 0; cursor: pointer;">üìÇ Importa JSON</label>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn" style="background-color: #d93025; margin-left: auto;" onclick="cancellaDati()">‚ö†Ô∏è Cancella Tutto</button>
            </div>
        </section>
    </main>

    <div id="modal-rda" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="titolo-modale-rda">Aggiungi Ordine (RDA / ODA)</h3>
                <button class="btn-close" onclick="chiudiModale('modal-rda')">&times;</button>
            </div>
            <p style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--brand-blue); display: none;" id="rda-altre-avviso">Modalit√† semplificata per funzioni aggiuntive.</p>
            
            <div class="form-grid" id="rda-form-standard">
                <div class="input-group"><label>Numero RDA</label><input type="text" id="rda-num"></div>
                <div class="input-group"><label>Data RDA</label><input type="date" id="rda-data"></div>
                <div class="input-group"><label>Numero ODA</label><input type="text" id="oda-num"></div>
                <div class="input-group"><label>Data ODA</label><input type="date" id="oda-data"></div>
            </div>

            <div class="form-grid">
                <div class="input-group" id="rda-funzione-container">
                    <label>Funzione Beneficiaria</label>
                    <select id="rda-funzione" onchange="toggleRdaMode()"></select>
                </div>
                <div class="input-group" id="rda-anno-container" style="display: none;">
                    <label>Anno Esercizio</label>
                    <input type="number" id="rda-anno">
                </div>
                <div class="input-group" id="rda-data-semplice-container" style="display: none;">
                    <label>Data</label>
                    <input type="date" id="rda-data-semplice">
                </div>
                <div class="input-group"><label>Valore Ordine (‚Ç¨)</label><input type="text" inputmode="decimal" id="rda-valore" placeholder="Es. 31.000,02"></div>
            </div>
            
            <div style="text-align: right; margin-top: 1rem;">
                <button class="btn btn-yellow" id="btn-salva-rda" onclick="salvaRda(this)">Salva Ordine</button>
            </div>
        </div>
    </div>

    <div id="modal-vap" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="titolo-modale-vap">Autorizza Pagamento (VAP)</h3>
                <button class="btn-close" onclick="chiudiModale('modal-vap')">&times;</button>
            </div>
            <p style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--brand-blue);" id="vap-ordine-ref"></p>
            <input type="hidden" id="vap-id-ordine">
            
            <div class="form-grid">
                <div id="vap-campi-standard" style="display: contents;">
                    <div class="input-group"><label>Numero VAP</label><input type="text" id="vap-num"></div>
                    <div class="input-group"><label>Data VAP</label><input type="date" id="vap-data"></div>
                </div>
                <div class="input-group"><label>Importo (‚Ç¨)</label><input type="text" inputmode="decimal" id="vap-valore" placeholder="Es. 31.000,02"></div>
                <div class="input-group"><label>Anno di Esercizio</label><input type="number" id="vap-anno" placeholder="Es. 2026"></div>
                <div class="input-group" id="vap-funzione-container">
                    <label>Funzione</label>
                    <select id="vap-funzione"></select>
                </div>
            </div>
            <div class="checkbox-group" id="vap-assestamento-container">
                <input type="checkbox" id="vap-assestamento">
                <label for="vap-assestamento">Segna come VAP in assestamento</label>
            </div>
            
            <div style="text-align: right; margin-top: 1.5rem;">
                <button class="btn btn-yellow" id="btn-salva-vap" onclick="salvaVap(this)">Registra Pagamento</button>
            </div>
        </div>
    </div>

    <script>
        /* --- MOTORE DATI E STATO GLOBALE --- */
        const DB_KEY = "contratti_db_v6"; 
        let appData = { contratti: [], ordini: [], vap: [], config: { miaFunzione: '', altreFunzioni: [] } };
        
        let tipoContrattoAttivo = 'quadro';
        let contrattoInGestioneId = null;
        let editContrattoId = null;
        let editOrdineId = null;
        let editVapId = null;

        window.onload = () => {
            const savedData = localStorage.getItem(DB_KEY);
            if(savedData) {
                const parsed = JSON.parse(savedData);
                appData = { ...appData, ...parsed };
            }
            if(appData.config) {
                document.getElementById('cfg-mia-funzione').value = appData.config.miaFunzione || '';
                document.getElementById('cfg-altre-funzioni').value = (appData.config.altreFunzioni || []).join(', ');
            }
            aggiungiRigaBudget(); calcolaQuadratura(); renderDashboard();
        };

        /* --- CONFIGURAZIONE --- */
        function salvaConfigurazione() {
            appData.config.miaFunzione = document.getElementById('cfg-mia-funzione').value.trim();
            appData.config.altreFunzioni = document.getElementById('cfg-altre-funzioni').value.split(',').map(s => s.trim()).filter(s => s !== '');
            salvaDati();
        }

        function getOptionsFunzioni() {
            let opts = `<option value="${appData.config.miaFunzione}">${appData.config.miaFunzione} (Mia)</option>`;
            appData.config.altreFunzioni.forEach(f => { opts += `<option value="${f}">${f}</option>`; });
            return opts;
        }

        /* --- FORMATTATORI --- */
        function formattatoreDataIT(dataISO) {
            if (!dataISO) return '-';
            const dataObj = new Date(dataISO);
            if (isNaN(dataObj.getTime())) return dataISO;
            return dataObj.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function parseImporto(valoreStr) {
            if (!valoreStr) return 0;
            let pulito = String(valoreStr).replace(/\./g, '').replace(',', '.');
            return parseFloat(pulito) || 0;
        }

        function formattatoreValuta(num) { 
            return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(num || 0); 
        }

        /* --- DATABASE --- */
        function salvaDati() { localStorage.setItem(DB_KEY, JSON.stringify(appData)); }
        function cancellaDati() { if(confirm("Sei sicuro di voler formattare il database?")) { localStorage.clear(); location.reload(); } }
        
        function exportData(btn) {
            withFeedback(btn, "Export...", "Scaricato", "üíæ Esporta JSON", () => {
                const dataStr = JSON.stringify(appData, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `backup_contratti.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            });
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    appData = { ...appData, ...imported };
                    salvaDati(); alert("Database importato!"); location.reload();
                } catch(err) { alert("Errore di lettura file."); }
            };
            reader.readAsText(file);
        }

        function withFeedback(btn, loadingText, successText, originalText, callback) {
            btn.disabled = true; btn.textContent = loadingText;
            setTimeout(() => {
                callback(); btn.textContent = successText; btn.style.backgroundColor = "#28a745"; btn.style.color = "#fff";
                setTimeout(() => { btn.disabled = false; btn.textContent = originalText; btn.style.backgroundColor = ""; btn.style.color = ""; }, 2000);
            }, 300);
        }

        /* --- NAVIGAZIONE --- */
        function switchView(viewId, btnElement) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            if(btnElement && btnElement.parentElement.tagName === 'NAV') {
                document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active-nav'));
                btnElement.classList.add('active-nav');
            }
            if(viewId === 'dashboard') {
                switchDashboardTab('archivio');
                renderDashboard();
            }
        }

        function switchDashboardTab(tab) {
            document.querySelectorAll('.dash-tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.segmented-control button').forEach(b => b.classList.remove('active-segment'));
            
            if(tab === 'archivio') {
                document.getElementById('dash-archivio').style.display = 'block';
                document.getElementById('tab-archivio').classList.add('active-segment');
                renderDashboard();
            } else if(tab === 'attivi') {
                document.getElementById('dash-attivi').style.display = 'block';
                document.getElementById('tab-attivi').classList.add('active-segment');
                renderContrattiAttivi();
            } else if(tab === 'budget') {
                document.getElementById('dash-budget').style.display = 'block';
                document.getElementById('tab-budget').classList.add('active-segment');
                renderBudgetAnnuale();
            }
        }

        function renderContrattiAttivi() {
            const container = document.getElementById('lista-contratti-attivi');
            const oggi = new Date().toISOString().split('T')[0];
            const attivi = appData.contratti.filter(c => c.dataFine >= oggi);
            
            if(attivi.length === 0) { container.innerHTML = '<div class="empty-state">Nessun contratto attivo alla data odierna.</div>'; return; }
            
            let html = '<table style="width:100%; border-collapse:collapse; font-size:0.9rem;">';
            html += '<tr style="text-align:left; border-bottom:2px solid var(--border-color);"><th style="padding:10px;">Fornitore</th><th>Scadenza</th><th>Valore Totale</th><th>Speso (VAP)</th><th>Residuo</th></tr>';
            
            attivi.forEach(c => {
                const ordiniC = appData.ordini.filter(o => o.idContratto === c.id);
                const speso = appData.vap.filter(v => ordiniC.some(o => o.id === v.idOrdine)).reduce((acc, v) => acc + v.valore, 0);
                html += `<tr style="border-bottom:1px solid var(--border-color);">
                    <td style="padding:10px;"><strong>${c.fornitore}</strong><br><small>${c.numero}</small></td>
                    <td>${formattatoreDataIT(c.dataFine)}</td>
                    <td>${formattatoreValuta(c.valore)}</td>
                    <td style="color:var(--brand-blue);">${formattatoreValuta(speso)}</td>
                    <td style="font-weight:600;">${formattatoreValuta(c.valore - speso)}</td>
                </tr>`;
            });
            html += '</table>';
            container.innerHTML = html;
        }

        function renderBudgetAnnuale() {
            const container = document.getElementById('report-budget-container');
            const annoRicerca = document.getElementById('budget-anno-filter').value;
            const miaFunzione = appData.config.miaFunzione;

            // Filtra VAP per anno e funzione primaria
            const vapsStruttura = appData.vap.filter(v => v.anno == annoRicerca && v.funzione === miaFunzione);
            
            if(vapsStruttura.length === 0) { container.innerHTML = `<div class="empty-state">Nessuna spesa registrata per la struttura ${miaFunzione} nell'anno ${annoRicerca}.</div>`; return; }

            const raggruppato = {};
            let totaleGenerale = 0;

            vapsStruttura.forEach(v => {
                const ordine = appData.ordini.find(o => o.id === v.idOrdine);
                const contratto = appData.contratti.find(c => c.id === (ordine ? ordine.idContratto : ''));
                const fornitore = contratto ? contratto.fornitore : 'N/D';
                
                if(!raggruppato[fornitore]) raggruppato[fornitore] = 0;
                raggruppato[fornitore] += v.valore;
                totaleGenerale += v.valore;
            });

            let html = `<div style="background:var(--bg-color); padding:1.5rem; border-radius:8px; margin-bottom:1.5rem; display:flex; justify-content:space-between; align-items:center;">
                <h4 style="color:var(--text-muted);">Totale Speso ${annoRicerca}:</h4>
                <span style="font-size:1.8rem; font-weight:700; color:var(--brand-blue);">${formattatoreValuta(totaleGenerale)}</span>
            </div>`;

            html += '<h5 style="margin-bottom:1rem; text-transform:uppercase; font-size:0.8rem;">Dettaglio per Fornitore</h5>';
            for (const [fornitore, totale] of Object.entries(raggruppato)) {
                const percent = ((totale / totaleGenerale) * 100).toFixed(1);
                html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem; border-bottom:1px solid var(--border-color);">
                    <span>${fornitore}</span>
                    <div style="text-align:right;">
                        <span style="font-weight:600;">${formattatoreValuta(totale)}</span>
                        <small style="display:block; color:var(--text-muted); font-size:0.7rem;">${percent}% del totale struttura</small>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        function switchContractType(formId, btnElement) {
            if(editContrattoId) return; 
            document.querySelectorAll('.contract-form').forEach(el => el.classList.remove('active'));
            document.getElementById(formId).classList.add('active');
            document.querySelectorAll('.segmented-control button').forEach(btn => btn.classList.remove('active-segment'));
            btnElement.classList.add('active-segment');
            tipoContrattoAttivo = formId.replace('form-', '');
            calcolaQuadratura();
        }

        function apriModale(id) { document.getElementById(id).classList.add('active'); }
        function chiudiModale(id) { document.getElementById(id).classList.remove('active'); }

        /* --- DASHBOARD --- */
        function renderDashboard() {
            const container = document.getElementById('lista-contratti-container');
            container.innerHTML = ''; 
            const search = document.getElementById('search-contratti').value.toLowerCase();
            let filtrati = [...appData.contratti].sort((a, b) => new Date(b.dataCreazione) - new Date(a.dataCreazione)).filter(c => `${c.fornitore||''} ${c.numero||''} ${c.tipo||''} ${c.funzioneGestore||''}`.toLowerCase().includes(search));
            
            if(filtrati.length === 0) { container.innerHTML = `<div class="empty-state">Nessun contratto trovato.</div>`; return; }

            filtrati.forEach(c => {
                let badge = c.tipo === 'quadro' ? 'badge-quadro' : (c.tipo === 'diretta' ? 'badge-diretta' : 'badge-terzi');
                let label = c.tipo === 'quadro' ? 'Quadro' : (c.tipo === 'diretta' ? 'Diretta' : 'Terze Funzioni');
                const ordiniC = appData.ordini.filter(o => o.idContratto === c.id);
                const vapsC = appData.vap.filter(v => ordiniC.some(o => o.id === v.idOrdine));
                const speso = vapsC.reduce((acc, v) => acc + v.valore, 0);
                
                const card = document.createElement('div'); card.className = 'contract-card';
                card.innerHTML = `
                    <div class="card-info">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span class="badge-tipo ${badge}">${label}</span>
                            <small style="color:var(--text-muted); font-size:0.7rem;">ID: ${c.id}</small>
                        </div>
                        <h4 style="margin: 4px 0;">${c.fornitore || 'Fornitore non specificato'}</h4>
                        <p><strong>N¬∞:</strong> ${c.numero || 'N/D'} | <strong>Periodo:</strong> ${formattatoreDataIT(c.dataInizio)} - ${formattatoreDataIT(c.dataFine)}</p>
                        <p style="font-size:0.8rem; margin-top:5px;">
                            <strong>Pagato:</strong> ${formattatoreValuta(speso)} 
                            <span style="color:var(--text-muted); margin-left:10px;">(Residuo: ${formattatoreValuta(c.valore - speso)})</span>
                        </p>
                    </div>
                    <div class="card-actions">
                        <span class="valore">${formattatoreValuta(c.valore)}</span>
                        <div style="margin-top:8px;">
                            <button class="btn btn-outline btn-small" onclick="caricaContrattoPerModifica('${c.id}')">‚úèÔ∏è Modifica</button>
                            <button class="btn btn-small" onclick="apriDettaglioContratto('${c.id}')">Gestisci Spese ‚Üí</button>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }

        /* --- CONTRATTI LOGIC --- */
        function caricaContrattoPerModifica(id) {
            editContrattoId = id; const ctr = appData.contratti.find(c => c.id === id); if(!ctr) return;
            tipoContrattoAttivo = ctr.tipo;
            document.querySelectorAll('.contract-form').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.segmented-control button').forEach(btn => { 
                btn.classList.remove('active-segment'); btn.style.opacity = "0.5"; btn.style.pointerEvents = "none"; 
            });
            document.getElementById(`form-${ctr.tipo}`).classList.add('active');
            document.getElementById(`seg-${ctr.tipo}`).classList.add('active-segment');
            document.getElementById(`seg-${ctr.tipo}`).style.opacity = "1";
            document.getElementById('titolo-form-contratto').innerText = "Modifica Contratto: " + (ctr.fornitore || 'Bozza');
            document.getElementById('btn-salva-contratto').innerText = "Aggiorna Contratto";

            if (ctr.tipo === 'quadro') {
                document.getElementById('cq-fornitore').value = ctr.fornitore || ''; document.getElementById('cq-numero').value = ctr.numero || '';
                document.getElementById('cq-inizio').value = ctr.dataInizio || ''; document.getElementById('cq-fine').value = ctr.dataFine || '';
                document.getElementById('cq-valore').value = ctr.valore ? String(ctr.valore).replace('.', ',') : ''; document.getElementById('cq-note').value = ctr.note || '';
                const containerRip = document.getElementById('container-ripartizioni'); containerRip.innerHTML = '';
                if(ctr.ripartizioni && ctr.ripartizioni.length > 0) { ctr.ripartizioni.forEach(rip => aggiungiRigaBudgetConDati(rip.funzione, rip.anno, rip.importo)); } else { aggiungiRigaBudget(); }
                calcolaQuadratura();
            } else if (ctr.tipo === 'diretta') {
                document.getElementById('cd-fornitore').value = ctr.fornitore || ''; document.getElementById('cd-numero').value = ctr.numero || '';
                document.getElementById('cd-inizio').value = ctr.dataInizio || ''; document.getElementById('cd-fine').value = ctr.dataFine || '';
                document.getElementById('cd-valore').value = ctr.valore ? String(ctr.valore).replace('.', ',') : ''; document.getElementById('cd-note').value = ctr.note || '';
            } else if (ctr.tipo === 'terzi') {
                document.getElementById('ct-fornitore').value = ctr.fornitore || ''; document.getElementById('ct-funzione').value = ctr.funzioneGestore || '';
                document.getElementById('ct-inizio').value = ctr.dataInizio || ''; document.getElementById('ct-fine').value = ctr.dataFine || '';
                document.getElementById('ct-valore').value = ctr.valore ? String(ctr.valore).replace('.', ',') : ''; document.getElementById('ct-note').value = ctr.note || '';
            }
            switchView('contratti', document.querySelectorAll('nav button')[1]);
        }

        function aggiungiRigaBudgetConDati(funz, anno, importo) {
            const container = document.getElementById('container-ripartizioni');
            const riga = document.createElement('div'); riga.className = 'budget-row';
            const valFormattato = importo ? String(importo).replace('.', ',') : '';
            riga.innerHTML = `
                <select class="b-funzione" style="flex: 2;">${getOptionsFunzioni()}</select>
                <input type="number" class="b-anno" style="flex: 1;" value="${anno||''}">
                <input type="text" inputmode="decimal" class="b-importo" oninput="calcolaQuadratura()" style="flex: 2;" value="${valFormattato}" placeholder="Es. 31000,00">
                <button onclick="this.parentElement.remove(); calcolaQuadratura()" style="background:none; border:none; cursor:pointer; font-size:1.2rem; color:var(--text-muted);">‚úï</button>`;
            if(funz) riga.querySelector('.b-funzione').value = funz;
            container.appendChild(riga);
        }
        function aggiungiRigaBudget() { aggiungiRigaBudgetConDati('','',''); }

        function calcolaQuadratura() {
            if(tipoContrattoAttivo !== 'quadro') { document.getElementById('btn-salva-contratto').disabled = false; return; }
            const totale = parseImporto(document.getElementById('cq-valore').value); 
            let somma = 0;
            document.querySelectorAll('.b-importo').forEach(i => somma += parseImporto(i.value));
            const badge = document.getElementById('cq-status-quadratura'); 
            document.getElementById('btn-salva-contratto').disabled = false;
            
            if (totale > 0 && Math.abs(totale - somma) < 0.01) { badge.textContent = "Budget Quadrato"; badge.style.background = "#e6f4ea"; badge.style.color = "#137333"; }
            else { badge.textContent = `Bozza (Scostamento: ${(totale - somma).toFixed(2)} ‚Ç¨)`; badge.style.background = "#fff4e5"; badge.style.color = "#b05a00"; }
        }

        function salvaContrattoAttivo(btn) {
            withFeedback(btn, "Salvataggio...", "Fatto!", editContrattoId ? "Aggiorna Contratto" : "Salva Contratto", () => {
                let ctr = { id: editContrattoId ? editContrattoId : "CTR-" + Date.now(), tipo: tipoContrattoAttivo, dataCreazione: editContrattoId ? appData.contratti.find(c=>c.id===editContrattoId).dataCreazione : new Date().toISOString() };
                if (tipoContrattoAttivo === 'quadro') {
                    ctr.fornitore = document.getElementById('cq-fornitore').value; ctr.numero = document.getElementById('cq-numero').value;
                    ctr.dataInizio = document.getElementById('cq-inizio').value; ctr.dataFine = document.getElementById('cq-fine').value;
                    ctr.valore = parseImporto(document.getElementById('cq-valore').value); ctr.note = document.getElementById('cq-note').value;
                    ctr.ripartizioni = []; document.querySelectorAll('.budget-row').forEach(row => { ctr.ripartizioni.push({ funzione: row.querySelector('.b-funzione').value, anno: row.querySelector('.b-anno').value, importo: parseImporto(row.querySelector('.b-importo').value) }); });
                } else if (tipoContrattoAttivo === 'diretta') {
                    ctr.fornitore = document.getElementById('cd-fornitore').value; ctr.numero = document.getElementById('cd-numero').value;
                    ctr.dataInizio = document.getElementById('cd-inizio').value; ctr.dataFine = document.getElementById('cd-fine').value;
                    ctr.valore = parseImporto(document.getElementById('cd-valore').value); ctr.note = document.getElementById('cd-note').value;
                    ctr.funzioneGestore = appData.config.miaFunzione;
                } else if (tipoContrattoAttivo === 'terzi') {
                    ctr.fornitore = document.getElementById('ct-fornitore').value; ctr.numero = "N/A"; ctr.funzioneGestore = document.getElementById('ct-funzione').value;
                    ctr.dataInizio = document.getElementById('ct-inizio').value; ctr.dataFine = document.getElementById('ct-fine').value;
                    ctr.valore = parseImporto(document.getElementById('ct-valore').value); ctr.note = document.getElementById('ct-note').value;
                }
                if (editContrattoId) { const idx = appData.contratti.findIndex(c => c.id === editContrattoId); if(idx !== -1) appData.contratti[idx] = ctr; } 
                else { appData.contratti.push(ctr); }
                salvaDati(); pulisciFormContratto(); switchView('dashboard', document.querySelectorAll('nav button')[0]);
            });
        }

        function pulisciFormContratto() {
            editContrattoId = null; document.querySelectorAll('.contract-form input, .contract-form textarea').forEach(i => i.value = '');
            document.getElementById('container-ripartizioni').innerHTML = ''; aggiungiRigaBudget(); calcolaQuadratura();
            document.getElementById('titolo-form-contratto').innerText = "Inserimento Nuovo Contratto"; document.getElementById('btn-salva-contratto').innerText = "Salva Contratto";
            document.querySelectorAll('.segmented-control button').forEach(btn => { btn.style.opacity = "1"; btn.style.pointerEvents = "auto"; });
            switchContractType('form-quadro', document.getElementById('seg-quadro'));
        }

        /* --- GESTIONE SPESE (RDA, VAP) --- */
        function apriDettaglioContratto(id) {
            contrattoInGestioneId = id; const ctr = appData.contratti.find(c => c.id === id); if(!ctr) return;
            let label = ctr.tipo === 'quadro' ? 'Contratto Quadro' : (ctr.tipo === 'diretta' ? 'Assegnazione Diretta' : 'Terze Funzioni');
            
            let statsHtml = '';
            if (ctr.tipo === 'quadro') {
                const ordiniCtr = appData.ordini.filter(o => o.idContratto === ctr.id);
                const impegnatoRda = ordiniCtr.reduce((sum, o) => sum + o.valore, 0);
                const vapsCtr = appData.vap.filter(v => ordiniCtr.some(o => o.id === v.idOrdine));
                const pagatoVap = vapsCtr.reduce((sum, v) => sum + v.valore, 0);
                
                // Raggruppamento statistiche per funzione
                let statsFunzioni = {};
                ordiniCtr.forEach(o => {
                    const f = o.funzione || 'N/D';
                    if (!statsFunzioni[f]) statsFunzioni[f] = { rda: 0, vap: 0 };
                    statsFunzioni[f].rda += o.valore;
                });
                vapsCtr.forEach(v => {
                    const f = v.funzione || 'N/D';
                    if (!statsFunzioni[f]) statsFunzioni[f] = { rda: 0, vap: 0 };
                    statsFunzioni[f].vap += v.valore;
                });

                let htmlFunzioni = Object.keys(statsFunzioni).map(f => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(0,0,0,0.15); border-radius: 4px; margin-bottom: 0.25rem;">
                        <strong style="color: #fff;">${f}</strong>
                        <div style="text-align: right; font-size: 0.85rem;">
                            <span style="margin-right: 15px;">Impegnato RDA: <span style="font-weight: 600;">${formattatoreValuta(statsFunzioni[f].rda)}</span></span>
                            <span>Speso VAP: <span style="font-weight: 600; color: var(--brand-yellow);">${formattatoreValuta(statsFunzioni[f].vap)}</span></span>
                        </div>
                    </div>
                `).join('');
                
                statsHtml = `
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 6px; margin-top: 1rem; font-size: 0.95rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 2.5rem; margin-bottom: 1rem;">
                        <div><span style="display:block; font-size:0.8rem; text-transform:uppercase; opacity:0.8;">Budget Totale</span><strong>${formattatoreValuta(ctr.valore)}</strong></div>
                        <div><span style="display:block; font-size:0.8rem; text-transform:uppercase; opacity:0.8;">Impegnato (RDA)</span><strong>${formattatoreValuta(impegnatoRda)}</strong> <br><small style="color:var(--brand-yellow);">Residuo RDA: ${formattatoreValuta(ctr.valore - impegnatoRda)}</small></div>
                        <div><span style="display:block; font-size:0.8rem; text-transform:uppercase; opacity:0.8;">Pagato Effettivo (VAP)</span><strong>${formattatoreValuta(pagatoVap)}</strong> <br><small style="color:var(--brand-yellow);">Residuo VAP: ${formattatoreValuta(ctr.valore - pagatoVap)}</small></div>
                    </div>
                    ${Object.keys(statsFunzioni).length > 0 ? `
                    <div style="border-top: 1px dashed rgba(255,255,255,0.3); padding-top: 0.75rem;">
                        <span style="display:block; font-size:0.8rem; text-transform:uppercase; opacity:0.8; margin-bottom: 0.5rem;">Dettaglio Quote per Funzione</span>
                        ${htmlFunzioni}
                    </div>` : ''}
                </div>`;
            }

            document.getElementById('spese-header').innerHTML = `<div style="display:flex; justify-content:space-between; align-items:flex-start;"><div><span style="background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px; font-size:0.8rem; text-transform:uppercase;">${label}</span><h3 style="margin-top:0.5rem;">${ctr.fornitore || 'Bozza'}</h3><p><strong>N¬∞:</strong> ${ctr.numero || 'N/D'} | <strong>Validit√†:</strong> ${formattatoreDataIT(ctr.dataInizio)} - ${formattatoreDataIT(ctr.dataFine)}</p></div><div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;"><div style="text-align:right;"><span style="font-size:1.5rem; font-weight:600;">${formattatoreValuta(ctr.valore)}</span><p style="margin:0;">Budget Totale</p></div><button class="btn btn-yellow btn-small" onclick="esportaPdfContratto('${ctr.id}')">üìÑ Esporta PDF</button></div></div>${statsHtml}${ctr.note ? `<div class="dettaglio-note"><strong>Note:</strong> ${ctr.note}</div>` : ''}`;
            
            const content = document.getElementById('spese-content');
            if (ctr.tipo === 'terzi') { content.innerHTML = `<div class="empty-state"><h4>Nessuna RDA necessaria</h4><p>Contratto gestito da ${ctr.funzioneGestore}.</p></div>`; } 
            else { content.innerHTML = `<div class="box-header"><div><h4>Elenco Ordini (RDA/ODA)</h4></div><button class="btn btn-yellow btn-small" onclick="predisponiRdaNuova()">+ Nuova RDA</button></div><div id="lista-ordini"></div>`; renderOrdini(ctr.id, ctr.tipo); }
            switchView('gestione-spese');
        }

        function esportaPdfContratto(id) {
            const ctr = appData.contratti.find(c => c.id === id); if(!ctr) return;
            const ordini = appData.ordini.filter(o => o.idContratto === id);
            const vaps = appData.vap.filter(v => ordini.some(o => o.id === v.idOrdine));
            const speso = vaps.reduce((sum, v) => sum + v.valore, 0);

            let html = `<!DOCTYPE html>
            <html lang="it">
            <head>
                <meta charset="UTF-8">
                <title>Report Contratto ${ctr.numero || 'ND'}</title>
                <style>
                    @page { size: A4; margin: 15mm; }
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; line-height: 1.5; font-size: 12px; }
                    h1 { color: #0146bc; border-bottom: 2px solid #eddc01; padding-bottom: 5px; margin-bottom: 15px; font-size: 20px; }
                    h3 { color: #0146bc; font-size: 14px; margin-top: 25px; border-bottom: 1px solid #d2d2d7; padding-bottom: 4px; }
                    .info-grid { display: table; width: 100%; margin-bottom: 20px; background: #f5f5f7; padding: 15px; border-radius: 6px; }
                    .info-row { display: table-row; }
                    .info-cell { display: table-cell; padding: 6px 10px; width: 50%; }
                    .table { width: 100%; border-collapse: collapse; margin-bottom: 20px; page-break-inside: auto; }
                    .table tr { page-break-inside: avoid; page-break-after: auto; }
                    .table th, .table td { border: 1px solid #d2d2d7; padding: 8px; text-align: left; vertical-align: top; }
                    .table th { background-color: #0146bc; color: white; }
                    .table tr:nth-child(even) { background-color: #f9f9f9; }
                    .totali { font-size: 14px; text-align: right; padding: 12px; background: #e8f0fe; font-weight: bold; color: #0146bc; border: 1px solid #b6d4fe; border-radius: 6px; page-break-inside: avoid; }
                    .vap-item { padding: 4px 0; border-bottom: 1px dotted #ccc; }
                    .vap-item:last-child { border-bottom: none; }
                    .da-liquidare { color: #d93025; font-size: 11px; margin-top: 4px; }
                </style>
            </head>
            <body>
                <h1>Dossier Riassuntivo Contratto</h1>
                <div class="info-grid">
                    <div class="info-row">
                        <div class="info-cell"><strong>Fornitore:</strong> ${ctr.fornitore || 'N/D'}</div>
                        <div class="info-cell"><strong>Numero Identificativo:</strong> ${ctr.numero || 'N/D'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-cell"><strong>Tipologia:</strong> ${ctr.tipo.toUpperCase()}</div>
                        <div class="info-cell"><strong>Periodo:</strong> ${formattatoreDataIT(ctr.dataInizio)} - ${formattatoreDataIT(ctr.dataFine)}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-cell"><strong>Valore Totale:</strong> ${formattatoreValuta(ctr.valore)}</div>
                        <div class="info-cell"><strong>Note:</strong> ${ctr.note || 'Nessuna'}</div>
                    </div>
                </div>
                
                <h3>Dettaglio Ordini e Pagamenti (VAP)</h3>
                <table class="table">
                    <thead><tr><th style="width:25%;">Ordine</th><th style="width:15%;">Data</th><th style="width:20%;">Valore</th><th style="width:40%;">Dettaglio VAP</th></tr></thead>
                    <tbody>`;
            
            if(ordini.length === 0) {
                html += `<tr><td colspan="4" style="text-align:center;">Nessun ordine registrato.</td></tr>`;
            } else {
                ordini.forEach(o => {
                    const ordVaps = vaps.filter(v => v.idOrdine === o.id);
                    const spesoOrd = ordVaps.reduce((acc, v) => acc + v.valore, 0);
                    const residuoOrd = o.valore - spesoOrd;
                    let vapsList = ordVaps.length > 0 ? ordVaps.map(v => `<div class="vap-item">&bull; VAP ${v.num||'Semp.'} del ${formattatoreDataIT(v.data||o.dataSemplice)}: <strong>${formattatoreValuta(v.valore)}</strong></div>`).join('') : '<span style="color:#86868b;">Nessun pagamento</span>';
                    
                    if (residuoOrd > 0) { vapsList += `<div class="da-liquidare">Residuo da liquidare: ${formattatoreValuta(residuoOrd)}</div>`; }

                    html += `<tr>
                        <td><strong>${o.rdaNum ? 'RDA: '+o.rdaNum : 'RDA: '+o.funzione}</strong><br><small style="color:#666;">${o.odaNum ? 'ODA: '+o.odaNum : ''}</small></td>
                        <td>${formattatoreDataIT(o.rdaData || o.dataSemplice)}</td>
                        <td><strong>${formattatoreValuta(o.valore)}</strong></td>
                        <td>${vapsList}</td>
                    </tr>`;
                });
            }
            
            html += `</tbody></table>
                <div class="totali">
                    Totale Impegnato: ${formattatoreValuta(ctr.valore)}<br>
                    Totale Liquidato (VAP): ${formattatoreValuta(speso)}<br>
                    <hr style="border-top:1px solid #0146bc; margin:8px 0;">
                    Residuo Disponibile: ${formattatoreValuta(ctr.valore - speso)}
                </div>
                <script>
                    window.onload = function() { 
                        setTimeout(function() { window.print(); }, 500);
                    };
                <\/script>
            </body>
            </html>`;

            let printWin = window.open('', '_blank');
            printWin.document.open();
            printWin.document.write(html);
            printWin.document.close();
        }

        function renderOrdini(idContratto, tipoContratto) {
            const container = document.getElementById('lista-ordini'); container.innerHTML = '';
            const ordiniCtr = appData.ordini.filter(o => o.idContratto === idContratto);
            if(ordiniCtr.length === 0) { container.innerHTML = `<div class="empty-state" style="padding:1rem;">Nessun ordine registrato.</div>`; return; }

            ordiniCtr.forEach(o => {
                const vaps = appData.vap.filter(v => v.idOrdine === o.id);
                let totaleVap = 0; vaps.forEach(v => totaleVap += v.valore); let residuo = o.valore - totaleVap;
                const isMia = o.funzione === appData.config.miaFunzione;

                let vapHtml = vaps.length === 0 ? `<p style="color:var(--text-muted); font-size:0.9rem; margin-top:0.5rem;">Nessun VAP registrato.</p>` : vaps.map(v => 
                    `<div class="vap-row">
                        <div>
                            <button class="btn-icon" onclick="caricaVapPerModifica('${v.id}')" title="Modifica VAP">‚úèÔ∏è</button>
                            <button class="btn-icon btn-icon-danger" onclick="eliminaVap('${v.id}')" title="Elimina VAP">üóëÔ∏è</button>
                            <strong>VAP:</strong> ${v.num || 'Semplificato'} | ${formattatoreDataIT(v.data)} | Anno: ${v.anno} | ${v.funzione} ${v.assestamento ? '<span class="vap-assestamento">Assestamento</span>' : ''}
                        </div>
                        <strong style="color:var(--brand-blue);">${formattatoreValuta(v.valore)}</strong>
                    </div>`
                ).join('');

                const card = document.createElement('div'); card.className = 'ordine-card';
                card.innerHTML = `
                    <div class="ordine-header" style="cursor:pointer;" onclick="const body = this.nextElementSibling; body.style.display = body.style.display === 'none' ? 'block' : 'none';">
                        <div onclick="event.stopPropagation();">
                            <h4 style="margin-bottom:0.2rem; display:flex; align-items:center;">
                                <button class="btn-icon" onclick="caricaRdaPerModifica('${o.id}')" title="Modifica RDA">‚úèÔ∏è</button>
                                <button class="btn-icon btn-icon-danger" onclick="eliminaRda('${o.id}')" title="Elimina RDA">üóëÔ∏è</button>
                                ${isMia ? `RDA: ${o.rdaNum||'-'} (ODA: ${o.odaNum||'-'})` : `Computo RDA ${o.funzione}`}
                                <span style="margin-left:10px; font-size:0.7rem; color:var(--brand-blue);">‚ñº</span>
                            </h4>
                            <span style="font-size:0.85rem; color:var(--text-muted); margin-left: 4rem;">
                                ${isMia ? `Data: ${formattatoreDataIT(o.rdaData)} | ODA: ${formattatoreDataIT(o.odaData)}` : `Data: ${formattatoreDataIT(o.dataSemplice)} | Anno: ${o.anno}`}
                            </span>
                        </div>
                        <div style="text-align:right;">
                            <span style="display:block; font-weight:600; font-size:1.1rem;">Valore: ${formattatoreValuta(o.valore)}</span>
                            <span style="display:block; font-size:0.85rem; color:${residuo < 0 ? 'red' : 'green'};">Da liquidare: ${formattatoreValuta(residuo)}</span>
                        </div>
                    </div>
                    <div class="ordine-body" style="display:none; border-top: 1px solid var(--border-color);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                            <h5 style="color:var(--text-muted); text-transform:uppercase; font-size:0.8rem;">Elenco Pagamenti (VAP)</h5>
                            <button class="btn btn-outline btn-small" onclick="predisponiVapNuovo('${o.id}', '${o.rdaNum||o.funzione}', '${tipoContratto}')">+ Aggiungi VAP</button>
                        </div>
                        ${vapHtml}
                    </div>`;
                container.appendChild(card);
            });
        }

        /* --- RDA LOGIC --- */
        function toggleRdaMode() {
            const funz = document.getElementById('rda-funzione').value;
            const isMia = funz === appData.config.miaFunzione;
            document.getElementById('rda-form-standard').style.display = isMia ? 'grid' : 'none';
            document.getElementById('rda-altre-avviso').style.display = isMia ? 'none' : 'block';
            document.getElementById('rda-anno-container').style.display = isMia ? 'none' : 'block';
            document.getElementById('rda-data-semplice-container').style.display = isMia ? 'none' : 'block';
        }

        function predisponiRdaNuova() {
            editOrdineId = null; document.querySelectorAll('#modal-rda input').forEach(i => i.value = '');
            const sel = document.getElementById('rda-funzione'); sel.innerHTML = getOptionsFunzioni();
            sel.value = appData.config.miaFunzione; toggleRdaMode();
            document.getElementById('titolo-modale-rda').innerText = "Aggiungi Ordine (RDA / ODA)"; 
            apriModale('modal-rda');
        }

        function caricaRdaPerModifica(id) {
            editOrdineId = id; const ord = appData.ordini.find(o => o.id === id); if(!ord) return;
            const sel = document.getElementById('rda-funzione'); sel.innerHTML = getOptionsFunzioni();
            sel.value = ord.funzione || appData.config.miaFunzione; toggleRdaMode();
            
            document.getElementById('rda-num').value = ord.rdaNum || ''; document.getElementById('rda-data').value = ord.rdaData || '';
            document.getElementById('oda-num').value = ord.odaNum || ''; document.getElementById('oda-data').value = ord.odaData || '';
            document.getElementById('rda-anno').value = ord.anno || ''; document.getElementById('rda-data-semplice').value = ord.dataSemplice || '';
            document.getElementById('rda-valore').value = String(ord.valore).replace('.', ',');
            
            document.getElementById('titolo-modale-rda').innerText = "Modifica Ordine"; 
            apriModale('modal-rda');
        }

        function salvaRda(btn) {
            withFeedback(btn, "Salvataggio...", "Salvato", editOrdineId ? "Aggiorna Ordine" : "Salva Ordine", () => {
                const funz = document.getElementById('rda-funzione').value;
                let ord = { 
                    id: editOrdineId ? editOrdineId : "ORD-" + Date.now(), 
                    idContratto: contrattoInGestioneId, 
                    funzione: funz,
                    valore: parseImporto(document.getElementById('rda-valore').value)
                };
                if(funz === appData.config.miaFunzione) {
                    ord.rdaNum = document.getElementById('rda-num').value; ord.rdaData = document.getElementById('rda-data').value;
                    ord.odaNum = document.getElementById('oda-num').value; ord.odaData = document.getElementById('oda-data').value;
                } else {
                    ord.anno = document.getElementById('rda-anno').value; ord.dataSemplice = document.getElementById('rda-data-semplice').value;
                }
                
                if(editOrdineId) { const idx = appData.ordini.findIndex(o => o.id === editOrdineId); if(idx !== -1) appData.ordini[idx] = ord; }
                else { appData.ordini.push(ord); }
                salvaDati(); chiudiModale('modal-rda'); renderOrdini(contrattoInGestioneId, appData.contratti.find(c=>c.id===contrattoInGestioneId).tipo);
            });
        }

        function eliminaRda(id) {
            if(confirm("Sei sicuro di voler eliminare questa RDA? Verranno eliminati anche i VAP collegati.")) {
                appData.ordini = appData.ordini.filter(o => o.id !== id);
                appData.vap = appData.vap.filter(v => v.idOrdine !== id); 
                salvaDati(); renderOrdini(contrattoInGestioneId, appData.contratti.find(c=>c.id===contrattoInGestioneId).tipo);
            }
        }

        /* --- VAP LOGIC --- */
        function predisponiVapNuovo(idOrdine, labelRda, tipoContratto) {
            editVapId = null; document.querySelectorAll('#modal-vap input[type="text"], #modal-vap input[type="number"], #modal-vap input[type="date"]').forEach(i => i.value = '');
            document.getElementById('vap-assestamento').checked = false; document.getElementById('vap-id-ordine').value = idOrdine;
            document.getElementById('vap-ordine-ref').innerText = `Riferimento: ${labelRda}`;
            
            const ord = appData.ordini.find(o => o.id === idOrdine);
            const isMia = ord.funzione === appData.config.miaFunzione;
            document.getElementById('vap-campi-standard').style.display = isMia ? 'contents' : 'none';
            document.getElementById('vap-assestamento-container').style.display = isMia ? 'flex' : 'none';
            
            const sel = document.getElementById('vap-funzione'); sel.innerHTML = getOptionsFunzioni();
            sel.value = ord.funzione;
            
            document.getElementById('titolo-modale-vap').innerText = "Autorizza Pagamento (VAP)"; 
            apriModale('modal-vap');
        }

        function caricaVapPerModifica(id) {
            editVapId = id; const v = appData.vap.find(vap => vap.id === id); if(!v) return;
            const ord = appData.ordini.find(o => o.id === v.idOrdine);
            const isMia = ord.funzione === appData.config.miaFunzione;
            
            document.getElementById('vap-id-ordine').value = v.idOrdine;
            document.getElementById('vap-campi-standard').style.display = isMia ? 'contents' : 'none';
            document.getElementById('vap-assestamento-container').style.display = isMia ? 'flex' : 'none';
            
            const sel = document.getElementById('vap-funzione'); sel.innerHTML = getOptionsFunzioni();
            sel.value = v.funzione || ord.funzione;
            
            document.getElementById('vap-num').value = v.num || ''; document.getElementById('vap-data').value = v.data || '';
            document.getElementById('vap-valore').value = String(v.valore).replace('.', ','); document.getElementById('vap-anno').value = v.anno || '';
            document.getElementById('vap-assestamento').checked = v.assestamento || false;
            
            apriModale('modal-vap');
        }

        function salvaVap(btn) {
            withFeedback(btn, "Salvataggio...", "Fatto!", editVapId ? "Aggiorna VAP" : "Registra Pagamento", () => {
                const ord = appData.ordini.find(o => o.id === document.getElementById('vap-id-ordine').value);
                const isMia = ord.funzione === appData.config.miaFunzione;
                
                let vap = { 
                    id: editVapId ? editVapId : "VAP-" + Date.now(), 
                    idOrdine: ord.id, 
                    funzione: document.getElementById('vap-funzione').value,
                    valore: parseImporto(document.getElementById('vap-valore').value), 
                    anno: document.getElementById('vap-anno').value
                };
                
                if(isMia) {
                    vap.num = document.getElementById('vap-num').value;
                    vap.data = document.getElementById('vap-data').value;
                    vap.assestamento = document.getElementById('vap-assestamento').checked;
                } else {
                    vap.data = ord.dataSemplice; // Coerenza con ordine semplificato
                }

                if(editVapId) { const idx = appData.vap.findIndex(v => v.id === editVapId); if(idx !== -1) appData.vap[idx] = vap; }
                else { appData.vap.push(vap); }
                salvaDati(); chiudiModale('modal-vap'); renderOrdini(contrattoInGestioneId, appData.contratti.find(c=>c.id===contrattoInGestioneId).tipo);
            });
        }

        function eliminaVap(id) {
            if(confirm("Eliminare questo VAP?")) {
                appData.vap = appData.vap.filter(v => v.id !== id);
                salvaDati(); renderOrdini(contrattoInGestioneId, appData.contratti.find(c=>c.id===contrattoInGestioneId).tipo);
            }
        }
    </script>
</body>
</html>
